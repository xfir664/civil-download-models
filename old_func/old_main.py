# main.py
from operator import itemgetter
from selenium import webdriver
from setup_driver import setup_driver
from func.check_url import check_url
from func.find_all_elems import find_all_elems
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as EC
from func.wait_for_page_load import wait_for_page_load
from func.sanitize_windows_path import sanitize_windows_path
from func.wait_download_end import wait_download_end
from func.download_model import download_model
from func.extract_image_description import extract_image_description
from func.download_image import download_image
import os
import time
from selenium.webdriver.common.action_chains import ActionChains



elems = {
    "title": "//h1[contains(@class, 'mantine-Title-root')]",

    "version_container": "//div[contains(@class, 'mantine-Group-root') and contains(@style, '--group-justify: flex-start')]",

    "version_btns": "//button[contains(@class, 'mantine-Button-root') and @data-variant='filled' and @data-size='compact-sm']",

    "description_container": "//div[contains(@class, 'mantine-TypographyStylesProvider-root')]",

    "details_container": "//div[contains(@class, 'mantine-Accordion-item') and @data-active='true']",

    "image_link": "(//div[contains(@class, 'ModelVersionDetails_mainSection__46plL')]//a[.//img[contains(@class, 'EdgeImage_image__iH4_q')]])",

    "download_btn": "//a[@data-tour='model:download']",

    "details_type": ".//p[normalize-space()='Type']/ancestor::tr//td[2]//span[contains(@class, 'mantine-Badge-label')]",

    "details_base_model": ".//p[normalize-space()='Base Model']/ancestor::tr//td[2]//p[not(ancestor::a)]",

    "show_more_btn": ".//button[contains(@class, 'mantine-focus-auto') and contains(@class, 'mantine-Anchor-root')]",
}


error_arr = []



driver = setup_driver()
print("main start ‚úÖ")
for URL in URLS:
    itemgetter = 1
    try:
        print(f"processing page {URL} üí° {itemgetter} of {len(URLS)}")
        check_url(driver, URL)
        wait = WebDriverWait(driver, 100)

        wait.until(EC.presence_of_element_located((By.XPATH, elems["version_container"])))
        version_container = driver.find_element(By.XPATH, elems["version_container"])
        print('version_container found ‚úÖ')

        wait.until(EC.presence_of_element_located((By.XPATH, elems["version_btns"])))
        version_btns = version_container.find_elements(By.XPATH, elems["version_btns"])
        print(f'version_btns found ‚úÖ ({len(version_btns)})')

        # –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –≤—Å–µ –≤–µ—Ä—Å–∏–∏
        for i in range(len(version_btns)):
            # üîÅ –ü–µ—Ä–µ–ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å stale)
            wait_for_page_load(driver, wait, (By.XPATH, elems["version_btns"]))
            wait.until(EC.presence_of_element_located((By.XPATH, elems["version_btns"])))
            version_btns = version_container.find_elements(By.XPATH, elems["version_btns"])
            button = version_btns[i]
            print(f"button: {button}")
            version_text = button.text.strip()
            print(f"Clicking version: '{version_text}'")

            wait.until(EC.element_to_be_clickable((By.XPATH, elems["version_btns"])))

            driver.execute_script("arguments[0].scrollIntoView({block: 'center', inline: 'center'});", button)

            ActionChains(driver).move_to_element(button).click().perform()
            
            # üî¥ –ö–ª–∏–∫–∞–µ–º
            print(f"version '{version_text}' clicked ‚úÖ")
            
            # üîÅ –ñ–¥—ë–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            wait_for_page_load(driver, wait, (By.XPATH, elems["download_btn"]))

            # ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–û–õ–£–ß–ê–ï–ú –í–°–ï –≠–õ–ï–ú–ï–ù–¢–´
            all_elems = find_all_elems(driver, elems)
            if not all_elems:
                print(f"‚ùå Failed to parse version: '{version_text}'")
            print(f"‚úÖ Successfully parsed version: '{version_text}'")

            # ‚úÖ –°–æ–∑–¥–∞—ë–º –ø—É—Ç—å
            download_path = os.path.join(
                "downloads",
                "models",
                sanitize_windows_path(all_elems["details_type"].text),
                sanitize_windows_path(all_elems["details_base_model"].text),
                sanitize_windows_path(all_elems["title"].text),
                sanitize_windows_path(version_text)
            )

            img_path = os.path.join(download_path, "images")
            
            # ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫–∏
            os.makedirs(download_path, exist_ok=True)
            os.makedirs(img_path, exist_ok=True)
            print(f"‚úÖ Download path created: {download_path}")
            print(f"‚úÖ Image path created: {img_path}")

            try:
                show_more_btn = driver.find_element(By.XPATH, elems["show_more_btn"])
                print(f"‚úÖ Show more btn found")
                if show_more_btn.get_attribute("aria-expanded") == "false":
                    show_more_btn.click()
                    print(f"‚úÖ Show more btn clicked")
                    time.sleep(1)
            except Exception as e:
                print(f"‚ùå Show more btn not found")
                error_arr.append({
                    "error": "‚ùå Show more btn not found",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "show_more_btn",
                    "version": version_text
                })

            try: 
                desc_file_path = os.path.join(download_path, "description.txt")
                if not os.path.isfile(desc_file_path):
                    desc_elems = all_elems["description_container"].find_elements(By.XPATH, ".//*")
                    desc_text = ""
                    for elem in desc_elems:
                        desc_text += elem.text + "\n" + "\n"
                    with open(desc_file_path, "w", encoding="utf-8") as f:
                        f.write(desc_text)
                    print(f"‚úÖ Description file created: {desc_file_path}")
                else:
                    print(f"‚ö†Ô∏è Skipped: {desc_file_path} already exists")
            except Exception as e:
                error_arr.append({
                    "error": "‚ùå Description container not found",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "description_container",
                    "version": version_text
                })
                print(f"‚ùå Description container not found: {e}")
                

            # ‚úÖ –°—Å—ã–ª–∫–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
            links_file = os.path.join(download_path, "description-links.txt")
            if not os.path.isfile(links_file):
                links = all_elems["description_container"].find_elements(By.TAG_NAME, "a")
                links_output = []
                for link in links:
                    href = link.get_attribute("href")
                    text = link.text.strip()
                    if href and text:
                        links_output.append(f"{href} - {text}")
                    elif href:
                        links_output.append(href)
                with open(links_file, "w", encoding="utf-8") as f:
                    f.write("\n".join(links_output))
                print(f"‚úÖ Links file created: {links_file}")
            else:
                print(f"‚ö†Ô∏è Skipped: {links_file} already exists")

            # ‚úÖ –î–µ—Ç–∞–ª–∏ (—Ç–µ–∫—Å—Ç —Ç–∞–±–ª–∏—Ü—ã)
            try:
                details_file = os.path.join(download_path, "details.txt")
                if not os.path.isfile(details_file):
                    details_text = all_elems["details_container"].text
                    with open(details_file, "w", encoding="utf-8") as f:
                        f.write(details_text)
                    print(f"‚úÖ Details file created: {details_file}")
                else:
                    print(f"‚ö†Ô∏è Skipped: {details_file} already exists")
            except Exception as e:
                error_arr.append({
                    "error": "‚ùå Details container not found",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "details_container",
                    "version": version_text
                })
                print(f"‚ùå Details container not found: {e}")
                

            # ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ requests
            try:
                if download_model(all_elems, driver, download_path):
                    print("üéâ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!")
                else:
                    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª.")
            except Exception as e:
                error_arr.append({
                    "error": "‚ùå Failed to download model",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "download_model",
                    "version": version_text
                })
                print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª: {e}")
            
            # ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–û–õ–£–ß–ê–ï–ú –í–°–ï –≠–õ–ï–ú–ï–ù–¢–´
            all_elems = find_all_elems(driver, elems)
            if not all_elems:
                print(f"‚ùå Failed to parse version: '{version_text}'")
                error_arr.append({
                    "error": "‚ùå Failed to parse version",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "image_link",
                    "version": version_text
                })
                print(f"‚ùå Image link not found: {e}")
            else:
                print(f"‚úÖ Successfully parsed version: '{version_text}'")

            # ‚úÖ –ö–õ–ò–ö–ù–£–¢–¨ –ù–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï
            try:
                all_elems['image_link'].click()
                print(f"‚úÖ Image clicked")
            except Exception as e:
                error_arr.append({
                    "error": "‚ùå Image link not found",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "image_link",
                    "version": version_text
                })
                print(f"‚ùå Image link not found: {e}")

            wait_for_page_load(driver, wait, (By.XPATH, ".//div[contains(@class, 'flex flex-col gap-3') and contains(@class, 'mantine-Paper-root')]"))
            print(f"‚úÖ Page loaded")
            try:
                paggination_btns = driver.find_elements(By.XPATH, ".//button[contains(@class, 'mantine-focus-auto h-1 max-w-6 flex-1 rounded border border-solid border-gray-4 bg-white shadow-2xl') and contains(@class, 'mantine-UnstyledButton-root')]")
            except Exception as e:
                error_arr.append({
                    "error": "‚ùå Pagination btn not found",
                    "url": URL,
                    "itemgetter": itemgetter,
                    "title": all_elems["title"].text,
                    "error_location": "paggination_btns",
                    "version": version_text
                })
                print(f"‚ùå Pagination btn not found: {e}")

            
            for btn in range(len(paggination_btns)):

                try:
                    print(f"‚úÖ Pagination btn: {btn + 1} clicked  in {len(paggination_btns)} btns")
                    paggination_btns[btn].click()
                    print(f"‚úÖ Pagination btn clicked ‚úÖ")
                except Exception as e:
                    error_arr.append({
                        "error": "‚ùå Pagination btn not found",
                        "url": URL,
                        "itemgetter": itemgetter,
                        "img_iterration": btn + 1,
                        "title": all_elems["title"].text,
                        "error_location": "paggination_btns",
                        "version": version_text
                    })
                    print(f"‚ùå Pagination btn not found: {e}")

                time.sleep(3)
                wait_for_page_load(driver, wait, (By.XPATH, ".//div[contains(@class, 'flex flex-col gap-3') and contains(@class, 'mantine-Paper-root')]"))
                print(f"‚úÖ Page loaded")

                img_description = driver.find_element(By.XPATH, ".//div[contains(@class, 'flex flex-col gap-3') and contains(@class, 'mantine-Paper-root')]")
                print(f"‚úÖ Image description found")

                try: 
                    data_list = img_description.find_element(By.XPATH, ".//ul[contains(@class, 'flex list-none flex-col')]")
                    data_list_items = data_list.find_elements(By.XPATH, ".//li[contains(@class, 'flex flex-col')]")
                    if(len(data_list_items) > 3):
                        print(f"‚úÖ Data list items len {len(data_list_items)}")
                        list_show_more_btn = img_description.find_element(By.XPATH, ".//div[contains(@class, 'flex flex-col')]//div[contains(@class, 'flex justify-start')]//p[contains(@class, 'mantine-focus-auto cursor-pointer')]")
                        list_show_more_btn.click()
                except Exception as e:
                    print(f"‚ùå error: {e}")
                    error_arr.append({
                        "error": "‚ùå Data container not found",
                        "url": URL,
                        "itemgetter": itemgetter,
                        "img_iterration": btn + 1,
                        "title": all_elems["title"].text,
                        "error_location": "data_list",
                        "version": version_text
                    })

                try:
                    prompts_container = img_description.find_elements(By.XPATH, ".//div[contains(@class, 'mantine-focus-auto relative break-words') and contains(@class, 'mantine-Text-root')]")

                    for prompt in prompts_container:
                        if prompt.get_attribute("data-line-clamp") == "true":
                            print(f"‚úÖ Prompt: {prompt}")
                            prompt.find_element(By.XPATH, ".//span[contains(@class, 'absolute') and contains(@class, 'bottom-0') and contains(@class, 'right-0') and contains(@class, 'flex') and contains(@class, 'select-none') and contains(@class, 'items-end')]").click()
                except Exception as e:
                    print(f"‚ùå error: not found show more btn")

                if not os.path.isfile(os.path.join(img_path, f"img-{btn}.txt")):
                    description_text = img_description.find_elements(By.XPATH, ".//*")
                    description_text_output = []
                    for elem in description_text:
                        description_text_output.append(elem.text.strip())
                    img_description_links = img_description.find_elements(By.TAG_NAME, "a")
                    img_description_links_output = []
                    for link in img_description_links:
                        img_href = link.get_attribute("href")
                        img_text = link.text.strip()
                        if img_href and img_text:
                            img_description_links_output.append(f"{img_href} - {img_text}")
                        elif img_href:
                            img_description_links_output.append(img_href)

                    with open(os.path.join(img_path, f"img-{btn}.txt"), "w", encoding="utf-8") as f:
                        f.write("\n".join(description_text_output) + "\n" + "\n".join(img_description_links_output))
                    print(f"‚úÖ Image description file created: {os.path.join(img_path, f'img-{btn}.txt')}")
                else:
                    print(f"‚ö†Ô∏è Skipped: {os.path.join(img_path, f'img-{btn}.txt')} already exists")

                # ‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï
                try:
                    img_container = driver.find_element(By.XPATH, ".//div[contains(@class, 'flex min-h-0 flex-1 items-stretch justify-stretch')]")
                    print(f"‚úÖ Image container found")
                    image = img_container.find_element(By.XPATH, ".//img[contains(@class, 'EdgeImage_image__iH4_q')]")
                    print(f"‚úÖ Image found")
                    time.sleep(10)
                    if download_image(image, driver, img_path, f"img-{btn}"):
                        print("üéâ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ!")
                    else:
                        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.")
                except Exception as e:
                    error_arr.append({
                        "error": "‚ùå Image not found",
                        "url": URL,
                        "itemgetter": itemgetter,
                        "img_iterration": btn + 1,
                        "title": all_elems["title"].text,
                        "error_location": "image",
                        "version": version_text
                    })
                    print(f"‚ùå Image not found: {e}")
                

            print('All images downloaded ‚úÖ')
            print('All images descriptions downloaded ‚úÖ')
            print('All images descriptions links downloaded ‚úÖ')

            close_btn = driver.find_element(By.XPATH, ".//button[contains(@class, 'mantine-focus-auto mantine-active size-9 rounded-full') and contains(@class, 'mantine-CloseButton-root') and contains(@class, 'mantine-UnstyledButton-root')]")
            close_btn.click()
            print(f"‚úÖ Close btn clicked")
            time.sleep(3)
            wait_for_page_load(driver, wait, (By.XPATH, elems["version_container"]))
            print(f"‚úÖ Page loaded")

            print(f"‚úÖ end {all_elems['title'].text}")
        print(f"page {URL} success ‚úÖ {itemgetter} of {len(URLS)}")
        itemgetter += 1
        
    except Exception as e:
        print(f"error ‚ùå processing page {URL}: {e}")
        print(f"main end with error ‚ùå press enter to quit")

if len(error_arr) > 0:
    for arr in error_arr:
        print(f"‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå")
        print(f"‚ùå Error: {arr['error']}")
        print(f"‚ùå URL: {arr['url']}")
        if 'itemgetter' in arr:
            print(f"‚ùå Itemgetter: {arr['itemgetter']}")
        if 'title' in arr:
            print(f"‚ùå Title: {arr['title']}")
        print(f"‚ùå Error location: {arr['error_location']}")
        if 'img_iterration' in arr:
            print(f"‚ùå Image iterration: {arr['img_iterration']}")
        if 'version' in arr:
            print(f"‚ùå Version: {arr['version']}")


